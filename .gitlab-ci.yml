image: binocarlos/cibase:v13

variables:
  DOCKER_API_VERSION: "1.23"
  DOCKER_HOST: tcp://docker:2376
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  NOCODE_API_HOSTNAME: https://app.nocode.works

stages:
  - publish

publish_standard:
  stage: publish
  only:
    refs:
      - master
    changes:
      - "standard/**/*"
  services:
  - docker:19.03-dind
  script:
    - docker build -t nocode-template-standard:local standard
    # test the template building against fixture data to catch silly errors
    - docker run --rm --entrypoint yarn -e ACCESS_TOKEN=none -e WEBSITE_ID=1 nocode-template-standard:local template:preview --cache-preview-file /app/test/fixtures/data.json
    - docker run --rm -e NOCODE_API_HOSTNAME -e ACCESS_TOKEN nocode-template-standard:local

publish_blog:
  stage: publish
  only:
    refs:
      - master
    changes:
      - "blog/**/*"
  services:
  - docker:19.03-dind
  script:
    - docker build -t nocode-template-blog:local blog
    # test the template building against fixture data to catch silly errors
    # TODO - get fixture data for the blog
    #- docker run --rm --entrypoint yarn -e ACCESS_TOKEN=none -e WEBSITE_ID=1 nocode-template-standard:local template:preview --cache-preview-file /app/test/fixtures/data.json
    - docker run --rm -e NOCODE_API_HOSTNAME -e ACCESS_TOKEN nocode-template-standard:local
    